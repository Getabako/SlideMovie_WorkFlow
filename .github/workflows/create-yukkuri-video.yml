name: Create Yukkuri Video

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: 'Input YAML file path (e.g., inputs/ai_industry_trends_2025.yml)'
        required: true
        default: 'inputs/ai_industry_trends_2025.yml'
  push:
    paths:
      - 'inputs/*.yml'

jobs:
  create-video:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: remotion-project/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Node dependencies
        run: npm install
        working-directory: ./remotion-project

      - name: Determine input file
        id: input
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "INPUT_FILE=${{ github.event.inputs.input_file }}" >> $GITHUB_ENV
          else
            # プッシュイベントの場合、変更されたYAMLファイルを使用
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^inputs/.*\.yml$' | head -1)
            if [ -z "$CHANGED_FILES" ]; then
              echo "No input YAML file changed"
              exit 1
            fi
            echo "INPUT_FILE=$CHANGED_FILES" >> $GITHUB_ENV
          fi
          echo "Using input file: $INPUT_FILE"

      - name: Create video
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        run: |
          python3 scripts/create_video.py $INPUT_FILE

      - name: Get topic name for artifact
        id: topic
        run: |
          TOPIC=$(python3 -c "
          import yaml, sys
          with open('${{ env.INPUT_FILE }}', 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)
              topic = data.get('topic', 'video')
              safe_topic = topic.replace(' ', '_').replace('/', '_').replace('\\\\', '_')
              print(safe_topic)
          ")
          echo "TOPIC_NAME=$TOPIC" >> $GITHUB_ENV

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: yukkuri-video-${{ env.TOPIC_NAME }}
          path: remotion-project/out/video.mp4

      - name: Upload all outputs
        uses: actions/upload-artifact@v4
        with:
          name: all-outputs-${{ env.TOPIC_NAME }}
          path: |
            slides/
            scripts_output/
            audio_output/
            remotion-project/out/

      - name: Summary
        run: |
          echo "## Video Creation Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ env.TOPIC_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`yukkuri-video-${{ env.TOPIC_NAME }}\` - Final video file" >> $GITHUB_STEP_SUMMARY
          echo "- \`all-outputs-${{ env.TOPIC_NAME }}\` - All intermediate files" >> $GITHUB_STEP_SUMMARY
