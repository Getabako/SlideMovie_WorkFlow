name: 2. Create Video

on:
  workflow_dispatch:
    inputs:
      presentation_name:
        description: 'Presentation name (e.g., æœ€æ–°ã®AIæ¥­ç•Œã®å‹•å‘2025)'
        required: true
        default: 'æœ€æ–°ã®AIæ¥­ç•Œã®å‹•å‘2025'

jobs:
  create-video:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: remotion-project/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Node dependencies
        run: npm install
        working-directory: ./remotion-project

      - name: Verify presentation exists
        run: |
          PRESENTATION_DIR="presentations/${{ github.event.inputs.presentation_name }}"
          if [ ! -d "$PRESENTATION_DIR" ]; then
            echo "Error: Presentation not found: $PRESENTATION_DIR"
            echo "Available presentations:"
            ls -la presentations/ || echo "No presentations directory found"
            exit 1
          fi
          echo "PRESENTATION_DIR=$PRESENTATION_DIR" >> $GITHUB_ENV

      - name: Prepare slide images
        run: |
          python3 scripts/prepare_slides_for_video.py ${{ env.PRESENTATION_DIR }}

      - name: Generate script from slides
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        run: |
          # ã‚¹ãƒ©ã‚¤ãƒ‰ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
          SLIDE_FILE="${{ env.PRESENTATION_DIR }}/${{ github.event.inputs.presentation_name }}_slide_with_images.md"
          if [ ! -f "$SLIDE_FILE" ]; then
            SLIDE_FILE="${{ env.PRESENTATION_DIR }}/${{ github.event.inputs.presentation_name }}_slide.md"
          fi
          python3 scripts/generate_script.py "$SLIDE_FILE"

      - name: Generate audio
        run: |
          SCRIPT_FILE=$(ls -t scripts_output/*.json | head -1)
          python3 scripts/generate_audio.py "$SCRIPT_FILE"

      - name: Generate timings
        run: |
          python3 scripts/generate_timings.py audio_output/audio_metadata.json

      - name: Prepare Remotion project
        run: |
          # ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
          cp audio_output/video_timings.json remotion-project/timings.json

          # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          mkdir -p remotion-project/public/audio
          cp audio_output/*.mp3 remotion-project/public/audio/

          # ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒã‚’ã‚³ãƒ”ãƒ¼
          mkdir -p remotion-project/public/slides
          cp slide_images/*.png remotion-project/public/slides/

          # ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
          cp slide_images/slides_metadata.json remotion-project/

      - name: Render video
        run: npm run build
        working-directory: ./remotion-project

      - name: Create video output directory
        run: |
          mkdir -p videos/${{ github.event.inputs.presentation_name }}

      - name: Copy video and related files
        run: |
          cp remotion-project/out/video.mp4 videos/${{ github.event.inputs.presentation_name }}/
          cp audio_output/video_timings.json videos/${{ github.event.inputs.presentation_name }}/
          cp -r scripts_output videos/${{ github.event.inputs.presentation_name }}/
          cp -r audio_output videos/${{ github.event.inputs.presentation_name }}/

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ github.event.inputs.presentation_name }}
          path: videos/${{ github.event.inputs.presentation_name }}/

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit video files
        run: |
          git add videos/${{ github.event.inputs.presentation_name }}/
          git add scripts_output/
          git add audio_output/
          git commit -m "feat: Add video - ${{ github.event.inputs.presentation_name }}

          Generated video with character animations and subtitles

          ðŸ¤– Generated by GitHub Actions" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Summary
        run: |
          echo "## Video Creation Complete! ðŸŽ¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Presentation:** ${{ github.event.inputs.presentation_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated Files:**" >> $GITHUB_STEP_SUMMARY
          echo "- Video with character animations (videos/${{ github.event.inputs.presentation_name }}/video.mp4)" >> $GITHUB_STEP_SUMMARY
          echo "- Subtitles and timing data" >> $GITHUB_STEP_SUMMARY
          echo "- Audio files" >> $GITHUB_STEP_SUMMARY
          echo "- Script data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Talk animation when speaking (talk1-6)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Idle animation when not speaking (idle1-6)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Auto-generated subtitles" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI-generated script" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Text-to-speech audio" >> $GITHUB_STEP_SUMMARY
